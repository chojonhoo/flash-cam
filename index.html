<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Flash Camera Pro</title>
    <style>
        :root {
            --primary-color: #ffcc00;
            --text-color: #fff;
            --safe-top: env(safe-area-inset-top, 50px); 
            --safe-bottom: env(safe-area-inset-bottom, 34px);
            --bg-color: #000;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
            display: flex;
            flex-direction: column;
        }

        /* --- 1. é¡¶éƒ¨æ  (Flash / RAW) --- */
        .top-bar {
            height: 60px;
            margin-top: calc(var(--safe-top) + 10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
            z-index: 20;
        }
        .icon-btn {
            font-size: 18px; 
            color: #888; /* é»˜è®¤ç°è‰² */
            font-weight: 600;
            padding: 8px;
            border-radius: 8px;
            transition: color 0.2s;
        }
        .icon-btn.active {
            color: var(--primary-color); /* æ¿€æ´»å˜é»„ */
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.4);
        }

        /* --- 2. å–æ™¯å™¨åŒºåŸŸ (åœ†è§’çŸ©å½¢é£æ ¼) --- */
        .viewfinder-container {
            flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            margin: 10px 16px; /* å››å‘¨ç•™ç™½ */
            position: relative;
            border-radius: 24px; /* å¤§åœ†è§’ */
            overflow: hidden;
            background: #1a1a1a;
            /* å¼ºåˆ¶ 3:4 æ¯”ä¾‹ï¼Œæˆ–è€…æ ¹æ®å±å¹•è‡ªé€‚åº”ï¼Œè¿™é‡Œè®¾ä¸ºè‡ªé€‚åº”å¡«æ»¡ä¸­é—´åŒºåŸŸ */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 0 1px #333; /* è¾¹æ¡†çº¿ */
        }

        /* è§†é¢‘å±‚ */
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: filter 0.3s ease;
        }

        /* æ„å›¾çº¿å±‚ */
        .overlays {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }
        .frame-line {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.6); /* æ›´åŠ æ˜æ˜¾çš„æš—è§’ */
            opacity: 0;
            transition: all 0.3s ease;
        }
        .frame-line::after {
            content: attr(data-focal);
            position: absolute; bottom: -24px; right: 0;
            color: #fff; font-size: 12px; font-weight: 600;
        }

        /* --- 3. åº•éƒ¨æ§åˆ¶åŒº (å¤§å¹…ä¸Šç§») --- */
        .bottom-controls {
            /* å…³é”®ä¿®æ”¹ï¼šå¢åŠ åº•éƒ¨ paddingï¼ŒæŠŠæ‰€æœ‰ä¸œè¥¿é¡¶ä¸Šå» */
            padding-bottom: calc(var(--safe-bottom) + 50px); 
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            z-index: 30;
            position: relative;
        }

        /* è°ƒèŠ‚é¢æ¿ (Slider) */
        .adj-panel {
            display: none;
            flex-direction: column;
            align-items: center;
            /* å…³é”®ä¿®æ”¹ï¼šå¢åŠ ä¸ä¸‹æ–¹æŒ‰é’®çš„è·ç¦» */
            margin-bottom: 30px; 
            height: 50px; /* å›ºå®šé«˜åº¦é˜²æ­¢æŠ–åŠ¨ */
            animation: fadeIn 0.2s;
        }
        .adj-panel.show { display: flex; }
        
        .adj-val {
            color: var(--primary-color); font-family: monospace; font-size: 16px; 
            font-weight: bold; margin-bottom: 15px; 
        }

        /* æ»‘å—æ ·å¼ä¼˜åŒ– */
        input[type=range] {
            -webkit-appearance: none; width: 60%; height: 3px;
            background: #444; border-radius: 2px; outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px;
            border-radius: 50%; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.5);
        }

        /* ç„¦æ®µé€‰æ‹©å™¨ */
        .focal-row { display: flex; gap: 15px; }
        .focal-opt {
            padding: 6px 12px; border-radius: 12px;
            background: #222; color: #888; font-size: 13px; border: 1px solid #333;
        }
        .focal-opt.active { background: #fff; color: #000; font-weight: bold; border-color: #fff; }

        /* å‚æ•°èƒ¶å›Šè¡Œ */
        .pills-row {
            display: flex; justify-content: center; gap: 16px;
            margin-bottom: 40px; /* å¢åŠ ä¸å¿«é—¨çš„è·ç¦» */
        }
        .pill {
            background: #1c1c1e;
            border: 1px solid #333;
            border-radius: 20px;
            height: 38px;
            padding: 0 16px;
            display: flex; align-items: center; gap: 8px;
            color: #aaa; font-size: 13px; font-weight: 500;
            transition: 0.2s;
        }
        .pill.active { background: #eee; color: #000; border-color: #fff; }

        /* å¿«é—¨ä¸ç›¸å†Œè¡Œ */
        .shutter-row {
            display: flex; justify-content: space-around; align-items: center;
            padding: 0 20px;
        }

        /* ç›¸å†Œé¢„è§ˆ */
        .gallery-preview {
            width: 54px; height: 54px;
            background: #222; border-radius: 10px; overflow: hidden;
            border: 1px solid #444;
            position: relative;
        }
        .gallery-preview img { width: 100%; height: 100%; object-fit: cover; opacity: 1; }

        /* å¿«é—¨æŒ‰é’® */
        .shutter-outer {
            width: 80px; height: 80px;
            border-radius: 50%;
            border: 4px solid #fff;
            display: flex; align-items: center; justify-content: center;
        }
        .shutter-inner {
            width: 66px; height: 66px;
            background: #fff; border-radius: 50%;
            transition: transform 0.1s;
        }
        .shutter-outer:active .shutter-inner { transform: scale(0.9); }

        /* åˆ‡æ¢ç›¸æœº */
        .cam-switch {
            width: 54px; height: 54px;
            border-radius: 50%; background: #222;
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 22px; border: 1px solid #333;
        }

        /* ç›¸æœºæŠ½å±‰ */
        .drawer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 280px;
            background: #1c1c1e; border-radius: 24px 24px 0 0;
            padding: 24px; padding-bottom: 40px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.2, 1);
            z-index: 100;
        }
        .drawer.open { transform: translateY(0); }
        
        .cam-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
        .cam-card { display: flex; flex-direction: column; align-items: center; gap: 8px; opacity: 0.5; }
        .cam-card.selected { opacity: 1; }
        .cam-icon {
            width: 50px; height: 50px; background: #2c2c2e; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
        }
        .cam-card.selected .cam-icon { background: #000; border: 2px solid var(--primary-color); }

        /* éšè—ç”»å¸ƒ (ç”¨äºæ‹ç…§å¤„ç†) */
        #captureCanvas { display: none; }
        
        /* é—ªé»‘ç‰¹æ•ˆ */
        #flash-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; pointer-events: none; opacity: 0; z-index: 200;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <!-- 1. é¡¶éƒ¨å¼€å…³ -->
    <div class="top-bar">
        <div class="icon-btn" id="btnFlash" onclick="toggleTopBtn('btnFlash')">âš¡</div>
        <div class="icon-btn" id="btnRaw" onclick="toggleTopBtn('btnRaw')">RAW</div>
    </div>

    <!-- 2. å–æ™¯å™¨ (ä¸­é—´åœ†è§’çŸ©å½¢) -->
    <div class="viewfinder-container">
        <video id="videoElement" autoplay playsinline muted></video>
        <div class="overlays">
            <div class="frame-line" id="frameLine" data-focal="50mm"></div>
        </div>
    </div>

    <!-- 3. åº•éƒ¨æ§åˆ¶åŒº -->
    <div class="bottom-controls">
        
        <!-- è°ƒèŠ‚æ»‘å—é¢æ¿ -->
        <div class="adj-panel" id="adjPanel">
            <div class="adj-val" id="adjVal">0.0</div>
            <div id="sliderBox" style="width:100%; display:flex; justify-content:center;"></div>
            <div class="focal-row" id="focalBox" style="display:none;">
                <div class="focal-opt active" onclick="setFocal(24, this)">24</div>
                <div class="focal-opt" onclick="setFocal(35, this)">35</div>
                <div class="focal-opt" onclick="setFocal(50, this)">50</div>
                <div class="focal-opt" onclick="setFocal(85, this)">85</div>
            </div>
        </div>

        <!-- å‚æ•°æŒ‰é’® -->
        <div class="pills-row">
            <div class="pill" id="pillTemp" onclick="toggleMode('temp')">
                <span>ğŸŒ¡</span> <span id="txtTemp">5500K</span>
            </div>
            <div class="pill" id="pillEv" onclick="toggleMode('ev')">
                <span>â˜€</span> <span id="txtEv">+0.0</span>
            </div>
            <div class="pill" id="pillFocal" onclick="toggleMode('focal')">
                <span style="font-weight:900; font-family:serif;">f</span> <span id="txtFocal">24mm</span>
            </div>
        </div>

        <!-- å¿«é—¨åŒºåŸŸ -->
        <div class="shutter-row">
            <!-- ç›¸å†Œé¢„è§ˆ -->
            <div class="gallery-preview" onclick="openGalleryTip()">
                <img id="galleryImg" src="https://images.unsplash.com/photo-1621517724883-9366df2205c5?w=100&q=80">
            </div>
            
            <div class="shutter-outer" onclick="takePhoto()">
                <div class="shutter-inner"></div>
            </div>
            
            <div class="cam-switch" onclick="toggleDrawer()">
                ğŸ“·
            </div>
        </div>
    </div>

    <!-- 4. ç›¸æœºé€‰æ‹©æŠ½å±‰ -->
    <div class="drawer" id="camDrawer">
        <div style="display:flex; justify-content:space-between; color:#fff; font-weight:600; font-size:18px;">
            <span>é€‰æ‹©ç›¸æœº</span>
            <span onclick="toggleDrawer()" style="cursor:pointer">âŒ„</span>
        </div>
        <div class="cam-grid">
            <div class="cam-card selected" onclick="setCam('leica', this)">
                <div class="cam-icon">ğŸ”´</div><span>M-Classic</span>
            </div>
            <div class="cam-card" onclick="setCam('ricoh', this)">
                <div class="cam-icon">âš«</div><span>GR-Mono</span>
            </div>
            <div class="cam-card" onclick="setCam('fuji', this)">
                <div class="cam-icon">ğŸŸ¢</div><span>NC-Color</span>
            </div>
             <div class="cam-card" onclick="setCam('kodak', this)">
                <div class="cam-icon">ğŸŸ¡</div><span>Gold 200</span>
            </div>
        </div>
    </div>

    <div id="flash-overlay"></div>
    <canvas id="captureCanvas"></canvas>

<script>
    // --- åˆå§‹åŒ–ç›¸æœº ---
    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: 1920, height: 1440 }, // å°è¯•è·å– 4:3 æ¯”ä¾‹
                audio: false 
            });
            document.getElementById('videoElement').srcObject = stream;
        } catch (err) {
            console.log("Cam Error", err);
        }
    }
    initCamera();

    // --- çŠ¶æ€ç®¡ç† ---
    const state = { mode: null, ev: 0, temp: 5500, focal: 24, cam: 'leica' };
    const els = {
        adjPanel: document.getElementById('adjPanel'),
        sliderBox: document.getElementById('sliderBox'),
        focalBox: document.getElementById('focalBox'),
        video: document.getElementById('videoElement'),
        frameLine: document.getElementById('frameLine')
    };

    // 1. é¡¶éƒ¨æŒ‰é’® Toggle
    function toggleTopBtn(id) {
        const btn = document.getElementById(id);
        btn.classList.toggle('active');
        // è¿™é‡Œåªæ˜¯è§†è§‰åé¦ˆï¼Œç½‘é¡µæ— æ³•ç›´æ¥æ§åˆ¶ç¡¬ä»¶ RAW æˆ– é—ªå…‰ç¯
    }

    // 2. è°ƒèŠ‚æ¨¡å¼åˆ‡æ¢
    function toggleMode(mode) {
        // é‡ç½®æ‰€æœ‰ Pill æ ·å¼
        document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));

        if (state.mode === mode) {
            state.mode = null;
            els.adjPanel.classList.remove('show');
            return;
        }
        
        state.mode = mode;
        els.adjPanel.classList.add('show');
        
        // é«˜äº®å½“å‰ Pill
        if(mode === 'temp') document.getElementById('pillTemp').classList.add('active');
        if(mode === 'ev') document.getElementById('pillEv').classList.add('active');
        if(mode === 'focal') document.getElementById('pillFocal').classList.add('active');

        els.sliderBox.innerHTML = '';
        els.focalBox.style.display = 'none';

        if (mode === 'ev') {
            document.getElementById('adjVal').innerText = (state.ev > 0 ? '+' : '') + state.ev.toFixed(1);
            createSlider(-2, 2, 0.1, state.ev, (v) => {
                state.ev = parseFloat(v);
                updateDisplay('ev', state.ev);
            });
        } else if (mode === 'temp') {
            document.getElementById('adjVal').innerText = state.temp + 'K';
            createSlider(3000, 8000, 100, state.temp, (v) => {
                state.temp = parseInt(v);
                updateDisplay('temp', state.temp);
            });
        } else if (mode === 'focal') {
            document.getElementById('adjVal').innerText = 'LENS';
            els.focalBox.style.display = 'flex';
        }
    }

    function createSlider(min, max, step, val, cb) {
        const input = document.createElement('input');
        input.type = 'range'; input.min = min; input.max = max; input.step = step; input.value = val;
        input.oninput = (e) => cb(e.target.value);
        els.sliderBox.appendChild(input);
    }

    function updateDisplay(type, val) {
        if(type === 'ev') {
            const txt = (val > 0 ? '+' : '') + val.toFixed(1);
            document.getElementById('adjVal').innerText = txt;
            document.getElementById('txtEv').innerText = txt;
        }
        if(type === 'temp') {
            document.getElementById('adjVal').innerText = val + 'K';
            document.getElementById('txtTemp').innerText = val + 'K';
        }
        applyFilters();
    }

    // 3. ç„¦æ®µé€»è¾‘ (åœ¨å–æ™¯æ¡†å†…ç”»çº¿)
    function setFocal(mm, el) {
        state.focal = mm;
        document.getElementById('txtFocal').innerText = mm + 'mm';
        document.querySelectorAll('.focal-opt').forEach(o => o.classList.remove('active'));
        el.classList.add('active');

        const base = 24; 
        if(mm === base) {
            els.frameLine.style.opacity = 0;
        } else {
            // è®¡ç®—æ¯”ä¾‹
            const ratio = base / mm; 
            // å‡è®¾è§†çª—æ˜¯è‡ªé€‚åº”çš„ï¼Œæˆ‘ä»¬è®©æ¡†çº¿ä¹Ÿæ˜¯è‡ªé€‚åº”æ¯”ä¾‹
            els.frameLine.style.width = (ratio * 100) + '%';
            els.frameLine.style.height = (ratio * 100) + '%'; // ä¿æŒå–æ™¯æ¡†çš„è‡ªèº«æ¯”ä¾‹
            els.frameLine.style.opacity = 1;
            els.frameLine.setAttribute('data-focal', mm + 'mm');
        }
    }

    // 4. æ»¤é•œæ¸²æŸ“
    function applyFilters() {
        let con = 1, sat = 1, gray = 0, sepia = 0;
        
        // ç›¸æœºé¢„è®¾
        if(state.cam === 'leica') { con = 1.15; sat = 1.1; }
        if(state.cam === 'ricoh') { con = 1.6; gray = 1; }
        if(state.cam === 'fuji') { sat = 1.3; con = 1.05; }
        if(state.cam === 'kodak') { sepia = 0.2; sat = 1.2; con = 1.1; }

        // EV
        let bright = 1 + (state.ev * 0.15);
        
        // Temp
        let hue = 0;
        const tempDiff = state.temp - 5500;
        if(tempDiff > 0) { sepia += (tempDiff/10000); hue = (tempDiff/5000) * 5; }
        else { hue = (tempDiff/4000) * 10; }

        els.video.style.filter = `brightness(${bright}) contrast(${con}) saturate(${sat}) grayscale(${gray}) hue-rotate(${hue}deg) sepia(${sepia})`;
    }

    function setCam(type, el) {
        state.cam = type;
        document.querySelectorAll('.cam-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        applyFilters();
    }

    // 5. æ ¸å¿ƒï¼šæ‹ç…§ä¸æ›´æ–°ç›¸å†Œ
    function takePhoto() {
        // 1. éœ‡åŠ¨ä¸é—ªé»‘
        if(navigator.vibrate) navigator.vibrate(50);
        const flash = document.getElementById('flash-overlay');
        flash.style.opacity = 1;
        setTimeout(() => flash.style.opacity = 0, 100);

        // 2. æˆªå–ç”»é¢
        const canvas = document.getElementById('captureCanvas');
        const context = canvas.getContext('2d');
        const video = els.video;

        // è®¾ç½®ç”»å¸ƒå°ºå¯¸ç­‰äºè§†é¢‘æµå°ºå¯¸
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // å°†å½“å‰è§†é¢‘å¸§ç”»åˆ°ç”»å¸ƒä¸Š
        // æ³¨æ„ï¼šæ»¤é•œæ˜¯ CSS æ•ˆæœï¼ŒdrawToCanvas é»˜è®¤æŠ“ä¸åˆ°æ»¤é•œã€‚
        // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬æŠ“å–åŸå›¾ï¼Œç„¶åæ›´æ–°ç›¸å†Œå›¾æ ‡ã€‚
        // å¦‚æœè¦å¸¦æ»¤é•œå­˜å›¾éœ€è¦å¤æ‚çš„ canvas åƒç´ å¤„ç†ï¼ŒDemo é˜¶æ®µæš‚ç•¥ã€‚
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // 3. ç”Ÿæˆå›¾ç‰‡æ•°æ®
        const dataURL = canvas.toDataURL('image/jpeg');

        // 4. æ›´æ–°å·¦ä¸‹è§’ç›¸å†Œå›¾æ ‡
        const galleryImg = document.getElementById('galleryImg');
        galleryImg.src = dataURL;
        galleryImg.style.opacity = 0.5;
        setTimeout(() => galleryImg.style.opacity = 1, 300); // é—ªä¸€ä¸‹è¡¨ç¤ºæ›´æ–°

        // 5. å°è¯•ä¸‹è½½ (Web App é™åˆ¶ï¼šå¿…é¡»ç”¨æˆ·ç¡®è®¤)
        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶é“¾æ¥æ¨¡æ‹Ÿä¿å­˜
        saveImage(dataURL);
    }

    function saveImage(dataURL) {
        const link = document.createElement('a');
        link.href = dataURL;
        // ç”Ÿæˆæ–‡ä»¶å
        const date = new Date();
        link.download = `FlashCam_${date.getTime()}.jpg`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function openGalleryTip() {
        alert("ç›¸å†Œé¢„è§ˆï¼šè¿™é‡Œæ˜¾ç¤ºçš„æ˜¯ä¸Šä¸€å¼ æ‹æ‘„çš„ç…§ç‰‡ã€‚\nç”±äºæ˜¯ç½‘é¡µç‰ˆï¼Œç…§ç‰‡å·²å°è¯•ä¸‹è½½åˆ°æ‚¨çš„ç³»ç»Ÿâ€˜æ–‡ä»¶â€™æˆ–â€˜ç›¸å†Œâ€™ä¸­ã€‚");
    }

    function toggleDrawer() {
        document.getElementById('camDrawer').classList.toggle('open');
        state.mode = null; // å…³é—­å‚æ•°é¢æ¿
        els.adjPanel.classList.remove('show');
    }
</script>
</body>
</html>
